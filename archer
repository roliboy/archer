#!/bin/bash

detect_boot_mode() {
    [ -d /sys/firmware/efi/efivars ] && echo UEFI || echo BIOS
}

detect_cpu_vendor() {
    [ -n "$(grep GenuineIntel /proc/cpuinfo)" ] && echo intel
    [ -n "$(grep AuthenticAMD /proc/cpuinfo)" ] && echo amd
}

detect_gpu_configuration() {
    [ -n "$(lspci | grep VGA | grep -i intel)" ] && local vga_controller=intel
    [ -n "$(lspci | grep VGA | grep -i amd)" ] && local vga_controller=amd
    [ -n "$(lspci | grep 3D | grep -i intel)" ] && local gfx_accelerator=intel
    [ -n "$(lspci | grep 3D | grep -i amd)" ] && local gfx_accelerator=amd
    [ -n "$(lspci | grep 3D | grep -i nvidia)" ] && local gfx_accelerator=nvidia

    [ "$vga_controller" = intel ] && local configuration=intel
    #TODO: test on different systems
    [ "$vga_controller" = intel ] && [ "$gfx_accelerator" = nvidia ] && local configuration=optimus

    echo "$configuration"
}

get_drive() {
    dialog --title 'Target drive' \
        --menu 'Select drive:' \
        --output-fd 1 \
        0 0 0 \
        $(
            lsblk -lno NAME,SIZE,TYPE |
            grep disk |
            awk '{ print "/dev/"$1, $2 }' |
            sort -u
        )
}

get_mirrorlist_country() {
    dialog --title 'Mirrorlist' \
        --menu 'Select country: ' \
        --output-fd 1 \
        0 0 0 \
        $(
            curl -s https://www.archlinux.org/mirrorlist/ |
            grep '<option value=".*">.*</option>' |
            awk -F'[<">]' '{ gsub(" ", "-", $5); print $3, $5 }'
        )
}

get_timezone() {
    dialog --title 'Timezone' \
        --menu 'Select timezone: ' \
        --output-fd 1 \
        0 0 0 \
        $(
            for zone in $(ls -F /usr/share/zoneinfo | grep \/$); do
                for region in $(ls /usr/share/zoneinfo/$zone); do
                    echo $zone$region '-';
                done;
            done;
        )
}

get_hostname() {
    dialog --title 'Hostname' --inputbox "Enter hostname: " --output-fd 1 0 0
}

get_username() {
    dialog --title 'Username' --inputbox "Enter username: " --output-fd 1 0 0
}

get_password() {
    dialog --title 'Password' --insecure --passwordbox "Enter password: " --output-fd 1 0 0
}





create_partitions() {
    for partition in $(parted -s $1 print | awk '/^ / {print $1}' | tac); do
        umount -l ${1}$partition > /dev/null 2>&1
        parted -s $1 rm $partition
    done

    parted -s $1 mklabel gpt

    parted -s $1 mkpart ESP fat32 1MiB 513MiB
    parted -s $1 set 1 boot on
    parted -s $1 mkpart primary ext4 513MiB 100%

    mkfs.vfat ${1}1 > /dev/null 2>&1
    mkfs.ext4 ${1}2 > /dev/null 2>&1

    mount ${1}2 /mnt
    mkdir /mnt/boot
    mount ${1}1 /mnt/boot
}


setup() {
    echo [LOG] > archer.log
    boot_mode="$(detect_boot_mode)"
    echo [DEBUG]: boot mode: =$boot_mode= >> archer.log
    cpu_vendor="$(detect_cpu_vendor)"
    echo [DEBUG]: cpu vendor: =$cpu_vendor= >> archer.log
    gpu_configuration="$(detect_gpu_configuration)"
    echo [DEBUG]: gpu configuration: =$gpu_configuration= >> archer.log
    selected_drive="$(get_drive)"
    echo [DEBUG]: selected drve: =$selected_drive= >> archer.log
    mirrorlist_country="$(get_mirrorlist_country)"
    echo [DEBUG]: mirrorlist country: =$mirrorlist_country= >> archer.log
    timezone="$(get_timezone)"
    echo [DEBUG]: timezone: =$timezone= >> archer.log
    hostname="$(get_hostname)"
    echo [DEBUG]: hostname: =$hostname= >> archer.log
    username="$(get_username)"
    echo [DEBUG]: username: =$username= >> archer.log
    password="$(get_password)"
    echo [DEBUG]: password: =$password= >> archer.log


    create_partitions "$selected_drive"
}

setup
